<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>購物車</title>
    <style>
        h1 { text-align: center; }
        body { margin: 50px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        td, th {
            border: 2px solid #000;
            padding: 10px;
            text-align: center;
        }
        .total {
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>購物車</h1>
    <hr style="border: 5px solid black; width: 50%;">
    <hr style="border: 1px solid black; width: 50%;"> 

    <table id="cartTable">
        <tr>
            <th>
                <input type="checkbox" id="selectAll" onchange="selectAllItems(this)">
                全選
            </th>
            <th>編號</th>
            <th>菜品名稱</th>
            <th>價格</th>
            <th>數量</th>
            <th>店家</th>
            <th>操作</th>
        </tr>
        <!-- 商品會在這裡顯示 -->
    </table>

    <center>
        <div class="total">
            <p>總金額: <span id="totalAmount">0</span> 元</p>
        </div>
    </center>

    <!-- 新增的備註欄位 -->
    <center>
        <div>
            <label for="orderNotes">點餐備註:</label><br>
            <textarea id="orderNotes" rows="4" cols="50" placeholder="在這裡輸入您的備註，例如：請多放辣椒"></textarea>
        </div>
    </center>

    <!-- 新增送餐地址欄位 -->
    <center>
        <div>
            <label for="deliveryAddress">送餐地址:</label><br>
            <textarea id="deliveryAddress" rows="4" cols="50" placeholder="請輸入送餐地址"></textarea>
        </div>
    </center>

    <script>
        let selectedShop = null;  // 用來紀錄選擇的店家

        document.addEventListener("DOMContentLoaded", () => {
            const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];

            if (cartItems.length === 0) {
                alert("購物車是空的！");
                return;
            }

            const cartTable = document.getElementById("cartTable");

            cartItems.forEach(item => {
                console.log(`載入購物車商品: ${item.name}, 店家: ${item.shop}`);
                const row = cartTable.insertRow();

                const quantityOptions = Array.from({ length: 20 }, (_, i) => i + 1).map(num => 
                    `<option value="${num}" ${num === item.quantity ? 'selected' : ''}>${num}</option>`
                ).join('');

                row.innerHTML = `
                    <td><input type="checkbox" class="cart-checkbox" data-id="${item.id}" data-shop="${item.shop}" onchange="updateTotalAmount(this)"></td>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>
                        <select class="quantity-select" id="quantity-${item.id}" onchange="updateQuantity(${item.id})">
                            ${quantityOptions}
                        </select>
                    </td>
                    <td>${item.price}</td>
                    <td>${item.shop}</td>
                    <td><button onclick="removeItem(${item.id})">刪除</button></td>
                `;
            });

            updateTotalAmount();  // 初始載入時更新總金額
        });

        function selectAllItems(checkbox) {
            const checkboxes = document.querySelectorAll(".cart-checkbox");
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateTotalAmount();
        }

        function updateQuantity(itemId) {
            let cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
            const item = cartItems.find(item => item.id === String(itemId));
            const quantity = parseInt(document.getElementById(`quantity-${itemId}`).value, 10);

            if (item) {
                item.quantity = quantity;
                localStorage.setItem("cartItems", JSON.stringify(cartItems));
            }

            updateTotalAmount();
        }

        function removeItem(itemId) {
            if (confirm("確定要刪除此商品嗎？")) {
                let cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
                cartItems = cartItems.filter(item => item.id !== String(itemId));
                localStorage.setItem("cartItems", JSON.stringify(cartItems));

                const row = document.querySelector(`.cart-checkbox[data-id="${itemId}"]`).closest("tr");
                if (row) {
                    row.remove();
                }

                updateTotalAmount();

                if (cartItems.length === 0) {
                    alert("購物車是空的！");
                }
            }
        }

        function updateTotalAmount(checkbox) {
            let totalAmount = 0;
            const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];

            if (checkbox) {
                const shop = checkbox.dataset.shop;
                if (selectedShop && selectedShop !== shop) {
                    alert("一筆訂單只能來自同一家店！");
                    checkbox.checked = false;
                    return;
                }
                selectedShop = shop;
            }

            cartItems.forEach(item => {
                const rowCheckbox = document.querySelector(`.cart-checkbox[data-id="${item.id}"]`);

                if (rowCheckbox && rowCheckbox.checked) {
                    const quantity = parseInt(document.getElementById(`quantity-${item.id}`).value, 10);
                    totalAmount += Math.floor(parseFloat(item.price) * quantity); // 改成整數
                }
            });

            document.getElementById("totalAmount").innerText = totalAmount;
        }

        function confirmOrder() {
            const totalAmount = parseInt(document.getElementById("totalAmount").innerText, 10);

            if (totalAmount === 0) {
                alert("請選擇商品後再下單！");
                return;
            }

            const orderNotes = document.getElementById("orderNotes").value;
            const deliveryAddress = document.getElementById("deliveryAddress").value;
            const paymentMethod = document.getElementById("paymentMethod").value;

            if (!deliveryAddress) {
                alert("請填寫送餐地址！");
                return;
            }

            if (!paymentMethod) {
                alert("請選擇付款方式！");
                return;
            }

            const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
            const selectedItems = [];
            const checkboxes = document.querySelectorAll('.cart-checkbox');

            checkboxes.forEach((checkbox) => {
                if (checkbox.checked) {
                    const itemId = parseInt(checkbox.dataset.id, 10);
                    const item = cartItems.find((cartItem) => parseInt(cartItem.id, 10) === itemId);

                    if (item) {
                        selectedItems.push({
                            itemId: item.id,
                            quantity: parseInt(document.getElementById(`quantity-${item.id}`).value, 10),
                            price: parseFloat(item.price),
                        });
                    }
                }
            });

            if (selectedItems.length === 0) {
                alert("請勾選至少一件商品！");
                return;
            }

            fetch('/api/createOrder', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        totalPrice: totalAmount,
        status: 'pending',
        note: orderNotes,
        deliveryAddress: deliveryAddress,
        paymentMethod: paymentMethod,
        items: selectedItems,
        rID: selectedShop // 傳遞餐廳 ID
    }),
})
.then((response) => response.json())
.then((data) => {
    if (data.success) {
        alert("訂單已成功提交！");
        localStorage.removeItem("cartItems");
        window.location.href = `/Trace?order_id=${data.orderId}`;
    } else {
        alert("訂單提交失敗：" + data.message);
    }
})
.catch((error) => {
    console.error("錯誤：", error);
    alert("發生錯誤，請稍後再試。");
});

        }
    </script>

    <center>
        <br>
        <div class="payment-section">
            <label for="paymentMethod">選擇付款方式:</label>
            <select id="paymentMethod">
                <option value="" disabled selected>請選擇付款方式</option>
                <option value="credit_card">信用卡</option>
                <option value="cash">現金</option>
            </select>
            <br><br>
            <button onclick="confirmOrder()">確認下單</button><br><br><br>
        </div>

        <button onclick="window.history.back()">回到上一頁</button>
        <br><br><br>
        <a href="/ShopList">回到商店清單</a>
    </center>

</body>
</html>
